var colx,rowx,w,h,tp,tl,xdis,rseed,bcolor,ecolor,easycam,hmgrid,interpgrid,hmbound,sclf=20,pw=600,ph=600,xrot=0,srot=0,rinterp=0,ittime=0,interprate=.01,rw=sclf*Math.floor(pw/sclf),rh=sclf*Math.floor(ph/sclf),animctl=!1,beginc="#50da62",endc="#9c57e1",startpos=[0,0,0,0],htmap=new xdiamondsquare,bstore=[],crange=400,ccorners=[0,0,0,0];function doublef(a,b,c,e,d){return htmap.vfmap(a,b,c,e,d)}function setup(){pixelDensity(1),w=windowWidth,h=windowHeight,bcolor=color(beginc),ecolor=color(endc),console.log(bcolor,ecolor);createCanvas(windowWidth,windowHeight,WEBGL);setAttributes("antialias",!0);var a={distance:400*((pw+ph)/600)/2,center:[0,0,0],rotation:[1,0,0,0]};console.log(Dw.EasyCam.INFO),Dw.EasyCam.prototype.apply=function(a){var b=this.cam;a=a||b.renderer,a&&(this.camEYE=this.getPosition(this.camEYE),this.camLAT=this.getCenter(this.camLAT),this.camRUP=this.getUpVector(this.camRUP),a._curCamera.camera(this.camEYE[0],this.camEYE[1],this.camEYE[2],this.camLAT[0],this.camLAT[1],this.camLAT[2],this.camRUP[0],this.camRUP[1],this.camRUP[2]))},easycam=new Dw.EasyCam(this._renderer,a),colx=Math.floor(pw/sclf),rowx=Math.floor(ph/sclf),hmgrid=htmap.vcreate(colx-1,rowx-1,doublef,crange,ccorners),hmbound=htmap.vgetbound(hmgrid,colx,rowx),console.log("heightmap",hmgrid),interpgrid=htmap.vcreate(colx-1,rowx-1,doublef,crange,ccorners,interpmap.createmap(hmgrid,colx,rowx)),console.log("interp",interpgrid),xdis=Math.sqrt((rh/2)**2+(rw/2)**2)-sclf,console.log("calc("+str(floor(28*(windowHeight/windowWidth)))+"vw + "+str(80+floor(10*(windowWidth/windowHeight)))+"px) 10px 10px 10px"),createHUD(),createCTL(),bindCTL()}var interpmap={ecurve:function(a){return Math.exp(-a)*Math.cos(2*PI*a)},withinrange:function(a,b,c){return a<b&&a>c},createmap:function(a,b,c){for(var d=[],e=[],f=0;10>f;f++)e[f]=map(noise(frameRate()*f/pw,frameRate()*f/ph),0,1,0,(hmbound[0]+hmbound[1])/2);for(var g=0;g<b;g++){d[g]=[];for(var h=0;h<c;h++){let b=map(a[g][h],-pw,pw,-5,5);for(var i=0;10>i;i++)d[g][h]=this.withinrange(a[g][h],e[i]+5,e[i]-5)?5*this.ecurve(b):0}}return d}};function windowResized(){w=windowWidth,h=windowHeight,resizeCanvas(windowWidth,windowHeight),easycam.setViewport([0,0,windowWidth,windowHeight]);var a=select("#controlhud");console.log(floor(32*(h/w))),a.elt.style.setProperty("margin","calc("+str(floor(28*(h/w)))+"vw + "+str(80+floor(10*(w/h)))+"px) 10px 10px 10px")}function tweenterrain(){perspective(60*PI/180,w/h,1,5e3),colorMode(RGB);background(32),console.log("test tween"),ambientLight(255,0,0),ambientLight(0,255,0),ambientLight(0,0,255),ambientLight(24),stroke(255),strokeWeight(.5),rotateX(PI/2),rotate(radians(xrot)),translate(-rw/2,-rh/2,(hmbound[0]+hmbound[1])/2);for(var a=0;a<rowx-1;a++){beginShape(TRIANGLE_STRIP);for(var b=0;b<colx;b++){var c=easeoutquad(ittime,hmgrid[b][a],interpgrid[b][a]-hmgrid[b][a],1),d=easeoutquad(ittime,hmgrid[b][a+1],interpgrid[b][a+1]-hmgrid[b][a+1],1);fill(beginc),tp=c,tl=d,vertex(b*sclf,a*sclf,c),vertex(b*sclf,(a+1)*sclf,d)}endShape()}if(srot=-1==srot?xrot:srot,xrot=null===srot?(xrot+.75)%359:srot,ittime=round((ittime+interprate)*10**splitTokens(str(interprate),".")[1].length)/10**splitTokens(str(interprate),".")[1].length,console.log(ittime,10**splitTokens(str(interprate),".")[1].length),1<ittime){ittime=0;let a=htmap.vcreate(colx-1,rowx-1,doublef,crange,ccorners),b=bcolor;interprate=floor(random(5,10))/1e3,console.log("interp value",interprate),hmgrid=interpgrid.slice(),console.log("test hmgrid",hmgrid),console.log(tp,tl),console.log(tl==interpgrid[colx-1][rowx-1]),bcolor=ecolor,ecolor=b,interpgrid=null,interpgrid=htmap.vcreate(colx-1,rowx-1,doublef,crange,ccorners,interpmap.createmap(a,colx,rowx))}}function drawterrain(){perspective(60*PI/180,w/h,1,5e3);var a=100;background(32),strokeWeight(1),stroke(255,32,0),line(0,0,0,a,0,0),ambientLight(255,0,0),stroke(32,255,32),line(0,0,0,0,a,0),ambientLight(0,255,0),stroke(0,32,255),line(0,0,0,0,0,a),ambientLight(0,0,255),ambientLight(24),stroke(255),strokeWeight(.5),rotateX(PI/2),rotate(radians(xrot)),translate(-rw/2,-rh/2,(hmbound[0]+hmbound[1])/2);for(var b=0;b<rowx-1;b++){beginShape(TRIANGLE_STRIP);for(var c=0;c<colx;c++){var d=easeincubic(rinterp,hmgrid[c][b],interpgrid[c][b]-hmgrid[c][b],1),e=easeincubic(rinterp,hmgrid[c][b+1],interpgrid[c][b+1]-hmgrid[c][b+1],1);fill(beginc),vertex(c*sclf,b*sclf,d),vertex(c*sclf,(b+1)*sclf,e)}endShape()}srot=-1==srot?xrot:srot,xrot=null===srot?(xrot+.75)%359:srot}function easeinquad(a,e,b,c){return a/=c,b*a*a+e}function easeoutquad(a,e,b,c){return a/=c,-b*a*(a-2)+e}function easeincubic(a,e,b,c){return a/=c,b*a*a*a+e}function easeoutcubic(a,e,b,c){return a=a/c-1,b*(a*a*a+1)+e}function comparearray(c,a){if(!Array.isArray(c)||!Array.isArray(a))return!1;if(c.length!=a.length)return!1;for(var b=0;b<c.length;b++){if(Array.isArray(c[b])&&Array.isArray(a[b])){if(!comparearray(c[b],a[b]))return!1;}else if(c[b]!=a[b])return!1;return!0}}function createHUD(){var a=select("#hud-lallign"),b=select("#hud-rallign");createElement("li","Framerate:").parent(a),createElement("li","Resolution:").parent(a),createElement("li","cam.dst:").parent(a).attribute("gap",""),createElement("li","cam.center:").parent(a),createElement("li","cam.rotation:").parent(a),createElement("li","plane.dimensions:").parent(a).attribute("gap",""),createElement("li","plane.rotation:").parent(a),createElement("li","placeholder").parent(b).class(""),createElement("li","placeholder").parent(b).class(""),createElement("li","placeholder").parent(b).class("blue").attribute("gap",""),createElement("li","placeholder").parent(b).class("blue"),createElement("li","placeholder").parent(b).class("blue"),createElement("li","placeholder").parent(b).class("orange").attribute("gap",""),createElement("li","placeholder").parent(b).class("orange")}var updatestuff={updateplane:function(a,b,c,d){(null!=a&&a!=pw||null!=b&&b!=ph)&&(pw=a,ph=b,colx=Math.floor(pw/sclf),rowx=Math.floor(ph/sclf),rw=sclf*Math.floor(pw/sclf),rh=sclf*Math.floor(ph/sclf),xdis=Math.sqrt((rh/2)**2+(rw/2)**2)-sclf),null!=c&&c!=crange&&(console.log(crange,c),crange=c),null==d||comparearray(d,ccorners)||(console.log(comparearray(d,ccorners)),ccorners=d),hmgrid=null,hmbound=null,intergrid=null,hmgrid=htmap.vcreate(colx-1,rowx-1,doublef,crange,ccorners),hmbound=htmap.vgetbound(hmgrid,colx,rowx),interpgrid=htmap.vcreate(colx-1,rowx-1,doublef,crange,ccorners,interpmap.createmap(hmgrid,colx,rowx)),console.log("heightmap",hmgrid),console.log("interp",interpgrid)}},bststuff={setgenerator:function(){var a=select("#gwidth"),b=select("#gheight");(null!=a.value()&&float(a.value())!=pw||null!=b.value()&&float(b.value())!=pw)&&updatestuff.updateplane(float(a.value()),float(b.value()))},updatesetting:function(){var a=select("#rangev");console.log("range",a.elt.innerHTML),float(a.elt.innerHTML)!=crange&&updatestuff.updateplane(pw,ph,float(a.elt.innerHTML),ccorners)},resetcam:function(){easycam.reset()},updatesliderg:function(){var a=select("#grange"),b=select("#rangev");b.elt.innerHTML=nfs(float(a.value()),1,1)},updateslideri:function(){var a=select("#irange"),b=select("#interpv");b.elt.innerHTML=nfs(float(a.value()),1,3),rinterp=float(a.value()),console.log(rinterp)},updateseedv:function(){var a=select("#rxseed");""==a.value()?(rseed=null,randomSeed()):null!=a.value()&&int(a.value())&&(rseed=int(a.value()),randomSeed(rseed)),console.log(rseed)},autorotate:function(){srot=null==srot?-1:null},updatecorners(){for(var a=[],b=0;4>b;b++)a[b]=float(select("#gcorner"+str(b+1)).value());console.log("setcorner",a),updatestuff.updateplane(pw,ph,crange,a)},tweenplane(){animctl=!animctl}};function createCTL(){for(var a=select("#hud-panel"),b=[],c=0;7>c;c++)b[c]=createElement("li","").parent(a).class("");createElement("element","Width:").parent(b[0]).class(""),createElement("input","").parent(b[0]).class("outline-inp").id("gwidth").attribute("type","text").attribute("value","600"),createElement("element","Height:").parent(b[0]).class(""),createElement("input","").parent(b[0]).class("outline-inp").id("gheight").attribute("type","text").attribute("value","600"),createElement("button","generate").parent(b[1]).class("outline-btn").id("generator"),createElement("button","reset_cam").parent(b[1]).class("outline-btn").id("reset_camera"),createElement("button","update").parent(b[1]).class("outline-btn").id("updater"),createElement("element","Range:").parent(b[2]).class(""),createElement("input","").parent(b[2]).class("outline-rnp").id("grange").attribute("type","range").attribute("min",0).attribute("max",800).attribute("value",400).attribute("step",.1),createElement("element",nfs(400,1,1)).parent(b[2]).class("").id("rangev"),createElement("element","Interp:").parent(b[3]).class(""),createElement("input","").parent(b[3]).class("outline-rnp").id("irange").attribute("type","range").attribute("min",0).attribute("max",1).attribute("value",0).attribute("step",.001),createElement("element",nfs(0,1,3)).parent(b[3]).class("").id("interpv"),createElement("element","Seed:").parent(b[4]).class(""),createElement("input","").parent(b[4]).class("outline-inp").id("rxseed").attribute("type","text"),createElement("button","rotate").parent(b[4]).class("outline-btn").id("rotator"),createElement("button","set").parent(b[4]).class("outline-btn").id("setter"),createElement("element","Corners:").parent(b[5]).class(""),createElement("input","").parent(b[5]).class("outline-inps").id("gcorner1").attribute("type","text").attribute("value","0"),createElement("input","").parent(b[5]).class("outline-inps").id("gcorner2").attribute("type","text").attribute("value","0"),createElement("input","").parent(b[5]).class("outline-inps").id("gcorner3").attribute("type","text").attribute("value","0"),createElement("input","").parent(b[5]).class("outline-inps").id("gcorner4").attribute("type","text").attribute("value","0"),createElement("button","animate").parent(b[6]).class("outline-btn").id("tweener").attribute("btm",""),bstore.push({id:"generator",type:"mouseClicked",callback:bststuff.setgenerator}),bstore.push({id:"reset_camera",type:"mouseClicked",callback:bststuff.resetcam}),bstore.push({id:"updater",type:"mouseClicked",callback:bststuff.updatesetting}),bstore.push({id:"grange",type:"mouseMoved",callback:bststuff.updatesliderg}),bstore.push({id:"irange",type:"mouseMoved",callback:bststuff.updateslideri}),bstore.push({id:"rxseed",type:"mouseOut",callback:bststuff.updateseedv}),bstore.push({id:"rotator",type:"mouseClicked",callback:bststuff.autorotate}),bstore.push({id:"setter",type:"mouseClicked",callback:bststuff.updatecorners}),bstore.push({id:"tweener",type:"mouseClicked",callback:bststuff.tweenplane}),console.log(windowHeight-15*a.elt.children.length+60)}function keyReleased(){return console.log(2,srot),88===keyCode?null==srot?xrot=0:srot=0:90===keyCode&&bststuff.updateseedv(),!1}function bindCTL(){for(var a=0;a<bstore.length;a++){let b=select("#"+bstore[a].id);b[bstore[a].type](bstore[a].callback)}}function displayHUD(){easycam.beginHUD();var a=easycam.getState(),b=select("#hud-rallign");b.elt.children[0].innerHTML=nfs(frameRate(),1,1),b.elt.children[1].innerHTML=nfs(easycam.getViewport(),1,0),b.elt.children[2].innerHTML=nfs(a.distance,1,2),b.elt.children[3].innerHTML=nfs(a.center,1,1),b.elt.children[4].innerHTML=nfs(a.rotation,1,3),b.elt.children[5].innerHTML=nfs([pw,ph],1,0),b.elt.children[6].innerHTML=nfs(xrot,1,1),easycam.endHUD()}function draw(){animctl?tweenterrain():drawterrain(),displayHUD()}
